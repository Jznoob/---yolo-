<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>找回密码 - 味知镜头</title>
  <link rel="stylesheet" href="auth.css">
  <link rel="stylesheet" href="food-particles.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>

<body>
  <div class="food-particles" id="foodParticles"></div>

  <div class="login-container">
    <h2 class="form-title">找回密码</h2>
    <p class="description">请输入您的注册邮箱，我们将向您发送重置密码的链接</p>

    <form id="forgotPasswordForm" onsubmit="return handleForgotPassword(event)">
      <div class="form-group">
        <input type="email" id="email" placeholder="注册邮箱" required>
        <div class="verification-code">
          <input type="text" id="emailCode" placeholder="验证码" required>
          <button type="button" onclick="sendVerificationCode()">获取验证码</button>
        </div>
      </div>

      <div id="resetPasswordSection" style="display: none;">
        <div class="form-group">
          <input type="password" id="newPassword" placeholder="新密码" required
            pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$" title="密码至少8位，包含字母和数字"
            onkeyup="checkPasswordStrength(this.value)">
          <div class="password-strength" id="passwordStrength"></div>
        </div>

        <div class="form-group">
          <input type="password" id="confirmPassword" placeholder="确认新密码" required>
        </div>
      </div>

      <button type="submit" id="submitButton">验证邮箱</button>
    </form>

    <div class="links">
      <a href="login.html">返回登录</a>
      <span class="separator">|</span>
      <a href="register.html">注册新账号</a>
    </div>

    <div id="message" class="error-message"></div>
  </div>

  <script>
    // 创建食物粒子
    function createFoodParticles() {
      const container = document.getElementById('foodParticles');
      const particleCount = 15;

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'food-particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 15 + 's';
        container.appendChild(particle);
      }
    }

    // 检查密码强度
    function checkPasswordStrength(password) {
      const strengthDiv = document.getElementById('passwordStrength');
      const hasLetter = /[a-zA-Z]/.test(password);
      const hasNumber = /\d/.test(password);
      const hasSpecial = /[!@#$%^&*]/.test(password);
      const isLongEnough = password.length >= 8;

      if (password.length === 0) {
        strengthDiv.className = 'password-strength';
        return;
      }

      if (hasLetter && hasNumber && hasSpecial && isLongEnough) {
        strengthDiv.className = 'password-strength strong';
      } else if ((hasLetter && hasNumber) || (hasLetter && hasSpecial) || (hasNumber && hasSpecial)) {
        strengthDiv.className = 'password-strength medium';
      } else {
        strengthDiv.className = 'password-strength weak';
      }
    }

    // 发送验证码
    let canSendCode = true;
    let countdown = 60;

    function sendVerificationCode() {
      if (!canSendCode) return;

      const email = document.getElementById('email').value;
      if (!email || !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        showMessage('请输入有效的邮箱地址');
        return;
      }

      // 发送验证码请求
      fetch('/send-verification-code', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email })
      })
        .then(response => response.json())
        .then(data => {
          if (data.code === 1) {
            startCountdown();
          } else {
            showMessage(data.msg || '发送失败，请稍后重试');
          }
        })
        .catch(error => {
          showMessage('发送失败，请稍后重试');
        });
    }

    function startCountdown() {
      const button = document.querySelector('.verification-code button');
      canSendCode = false;
      button.disabled = true;

      const timer = setInterval(() => {
        button.textContent = `${countdown}秒后重试`;
        countdown--;

        if (countdown < 0) {
          clearInterval(timer);
          button.textContent = '获取验证码';
          button.disabled = false;
          canSendCode = true;
          countdown = 60;
        }
      }, 1000);
    }

    let isEmailVerified = false;

    // 处理忘记密码
    async function handleForgotPassword(event) {
      event.preventDefault();

      const email = document.getElementById('email').value;
      const emailCode = document.getElementById('emailCode').value;

      if (!isEmailVerified) {
        // 验证邮箱和验证码
        try {
          const response = await fetch('/verify-email', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, emailCode })
          });

          const result = await response.json();

          if (result.code === 1) {
            // 邮箱验证成功，显示重置密码表单
            isEmailVerified = true;
            document.getElementById('resetPasswordSection').style.display = 'block';
            document.getElementById('submitButton').textContent = '重置密码';
            showMessage('邮箱验证成功，请设置新密码', 'success');
          } else {
            showMessage(result.msg || '验证失败，请重试');
          }
        } catch (error) {
          showMessage('验证失败，请稍后重试');
        }
      } else {
        // 重置密码
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
          showMessage('两次输入的密码不一致');
          return;
        }

        try {
          const response = await fetch('/reset-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email,
              emailCode,
              newPassword
            })
          });

          const result = await response.json();

          if (result.code === 1) {
            showMessage('密码重置成功！正在跳转...', 'success');
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 1500);
          } else {
            showMessage(result.msg || '密码重置失败，请重试');
          }
        } catch (error) {
          showMessage('密码重置失败，请稍后重试');
        }
      }
    }

    // 显示消息
    function showMessage(msg, type = 'error') {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = msg;
      messageDiv.style.color = type === 'success' ? '#52c41a' : '#ff4d4f';
    }

    // 页面加载时创建食物粒子
    window.addEventListener('load', createFoodParticles);
  </script>
</body>

</html>