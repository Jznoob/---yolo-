<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册 - 味知镜头</title>
    <link rel="stylesheet" href="auth.css"> <!-- 共用登录页面样式 -->
    <link rel="stylesheet" href="food-particles.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>

<body>
    <div class="food-particles" id="foodParticles"></div>

    <div class="login-container">
        <h2 class="form-title">开启美食之旅</h2>
        <p class="description">加入我们，记录和分享你的美食生活</p>

        <form id="registerForm" onsubmit="return handleRegister(event)">
            <div class="form-group">
                <input type="text" id="username" placeholder="用户名" required pattern="[a-zA-Z0-9_]{4,16}"
                    title="用户名应为4-16位字母、数字或下划线">
            </div>

            <div class="form-group">
                <input type="email" id="email" placeholder="电子邮箱" required>
                <div class="verification-code">
                    <input type="text" id="emailCode" placeholder="验证码" required>
                    <button type="button" onclick="sendVerificationCode()">获取验证码</button>
                </div>
            </div>

            <div class="form-group">
                <input type="password" id="password" placeholder="设置密码" required
                    pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$" title="密码至少8位，包含字母和数字"
                    onkeyup="checkPasswordStrength(this.value)">
                <div class="password-strength" id="passwordStrength"></div>
            </div>

            <div class="form-group">
                <input type="password" id="confirmPassword" placeholder="确认密码" required>
            </div>

            <button type="submit">注册账号</button>
        </form>

        <div class="social-login">
            <div class="social-login-title">
                <span>其他注册方式</span>
            </div>
            <div class="social-buttons">
                <div class="social-button" onclick="socialLogin('wechat')">
                    <i class="ri-wechat-line"></i>
                </div>
                <div class="social-button" onclick="socialLogin('qq')">
                    <i class="ri-qq-line"></i>
                </div>
                <div class="social-button" onclick="socialLogin('weibo')">
                    <i class="ri-weibo-line"></i>
                </div>
            </div>
        </div>

        <div class="links">
            <a href="login.html">已有账号？立即登录</a>
        </div>

        <div id="message" class="error-message"></div>
    </div>

    <script>
        // 创建食物粒子
        function createFoodParticles() {
            const container = document.getElementById('foodParticles');
            const particleCount = 15;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'food-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                container.appendChild(particle);
            }
        }

        // 检查密码强度
        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*]/.test(password);
            const isLongEnough = password.length >= 8;

            if (password.length === 0) {
                strengthDiv.className = 'password-strength';
                return;
            }

            if (hasLetter && hasNumber && hasSpecial && isLongEnough) {
                strengthDiv.className = 'password-strength strong';
            } else if ((hasLetter && hasNumber) || (hasLetter && hasSpecial) || (hasNumber && hasSpecial)) {
                strengthDiv.className = 'password-strength medium';
            } else {
                strengthDiv.className = 'password-strength weak';
            }
        }

        // 发送验证码
        let canSendCode = true;
        let countdown = 60;

        function sendVerificationCode() {
            if (!canSendCode) return;

            const email = document.getElementById('email').value;
            if (!email || !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showMessage('请输入有效的邮箱地址');
                return;
            }

            // 发送验证码请求
            fetch('/send-verification-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1) {
                        startCountdown();
                    } else {
                        showMessage(data.msg || '发送失败，请稍后重试');
                    }
                })
                .catch(error => {
                    showMessage('发送失败，请稍后重试');
                });
        }

        function startCountdown() {
            const button = document.querySelector('.verification-code button');
            canSendCode = false;
            button.disabled = true;

            const timer = setInterval(() => {
                button.textContent = `${countdown}秒后重试`;
                countdown--;

                if (countdown < 0) {
                    clearInterval(timer);
                    button.textContent = '获取验证码';
                    button.disabled = false;
                    canSendCode = true;
                    countdown = 60;
                }
            }, 1000);
        }

        // 处理注册
        async function handleRegister(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const emailCode = document.getElementById('emailCode').value;

            if (password !== confirmPassword) {
                showMessage('两次输入的密码不一致');
                return;
            }

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        emailCode
                    })
                });

                const result = await response.json();

                if (result.code === 1) {
                    showMessage('注册成功！正在跳转...', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                } else {
                    showMessage(result.msg || '注册失败，请稍后重试');
                }
            } catch (error) {
                showMessage('注册失败，请稍后重试');
            }
        }

        // 社交账号登录
        function socialLogin(platform) {
            // 根据不同平台处理第三方登录
            console.log(`使用 ${platform} 登录`);
        }

        // 显示消息
        function showMessage(msg, type = 'error') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = msg;
            messageDiv.style.color = type === 'success' ? '#52c41a' : '#ff4d4f';
        }

        // 页面加载时创建食物粒子
        window.addEventListener('load', createFoodParticles);
    </script>
</body>

</html>